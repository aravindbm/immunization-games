    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immunization Skills Lab</title>
    <style>
        /* --- CSS STYLES --- */
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --error: #c0392b; --bg: #f4f6f9; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; color: #333; }
        
        /* Main Container */
        #app { width: 900px; max-width: 100%; background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); overflow: hidden; min-height: 750px; display: flex; flex-direction: column; }
        
        /* Header */
        header { background: var(--primary); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .score-box { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        
        /* Screens */
        .screen { display: none; padding: 30px; flex-grow: 1; overflow-y: auto; animation: fadein 0.4s ease-in-out; }
        .screen.active { display: block; }
        @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography */
        h2 { color: var(--accent); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        p { line-height: 1.6; font-size: 1.05rem; }
        .highlight { background: #e8f6f3; color: #16a085; padding: 15px; border-left: 5px solid #1abc9c; border-radius: 4px; margin-bottom: 20px; }

        /* Inputs & Buttons */
        input { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s; margin-top: 10px; }
        button:hover { transform: translateY(-2px); shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--accent); color: var(--accent); }

        /* Feedback */
        .feedback { margin-top: 20px; padding: 15px; border-radius: 6px; font-weight: bold; display: none; }
        .feedback.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .feedback.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* --- STATION SPECIFIC STYLES --- */
        
        /* VVM */
        .vvm-grid { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .vvm-card { width: 140px; border: 2px solid #eee; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; }
        .vvm-card:hover { border-color: #bbb; }
        .vvm-card.selected { border-color: var(--accent); background: #ebf5fb; box-shadow: 0 0 0 2px var(--accent); }
        .vvm-circle { width: 50px; height: 50px; border-radius: 50%; background: #5d3f6a; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; }
        .vvm-square { width: 25px; height: 25px; }

        /* Schedule */
        .vaccine-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 20px; }
        .vax-tag { padding: 8px 12px; border: 1px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; font-size: 0.9rem; background: white; }
        .vax-tag:hover { background: #f8f9fa; }
        .vax-tag.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Route & Site */
        .child-view { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; background: #fafafa; padding: 20px; border-radius: 10px; }
        .child-emoji { font-size: 4rem; background: #fff; padding: 10px; border-radius: 50%; border: 3px solid #eee; }
        .rs-container { display: flex; gap: 20px; }
        .rs-column { flex: 1; }
        .rs-option { padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; text-align: center; background: white; }
        .rs-option:hover { background: #f1f1f1; }
        .rs-option.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Waste */
        .waste-zone { display: flex; justify-content: space-between; gap: 20px; margin-top: 20px; }
        .waste-source { width: 40%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .waste-item { padding: 20px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; font-size: 1.2rem; background: white; }
        .waste-item.selected { border-color: var(--accent); background: #ebf5fb; }
        .waste-item.done { opacity: 0.3; pointer-events: none; border-color: transparent; background: #eee; }

        .bin-row { width: 55%; display: flex; gap: 10px; justify-content: flex-end; align-items: flex-end; }
        .bin { width: 23%; height: 120px; border-radius: 6px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 0.85rem; text-align: center; transition: transform 0.2s; position: relative; }
        .bin:hover { transform: scale(1.05); }
        .bin-white { background: #fdfdfd; color: #333; border: 2px solid #999; }
        .bin-red { background: #e74c3c; }
        .bin-yellow { background: #f1c40f; color: #333; }
        .bin-blue { background: #3498db; }
        
        /* Syringe States for Waste */
        .syringe-state { font-size: 0.8rem; display: block; margin-top: 5px; color: #666; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div>üè• Immunization Skills Lab</div>
        <div class="score-box">
            <span id="header-name">Student</span> | Score: <span id="header-score">0</span>
        </div>
    </header>

    <div id="screen-login" class="screen active">
        <h2>Welcome</h2>
        <div class="highlight">
            <p><strong>Goal:</strong> Complete the immunization session for a randomly assigned child.</p>
            <p>You will be assessed on VVM, Open Vial Policy, Scheduling, Technique, and Waste Disposal.</p>
        </div>
        <div style="max-width: 400px; margin: 0 auto;">
            <label>Name</label>
            <input type="text" id="inp-name" placeholder="Full Name">
            <label>Roll Number</label>
            <input type="text" id="inp-roll" placeholder="Roll No">
            <button class="btn-primary" style="width:100%" onclick="startGame()">Start Session</button>
        </div>
    </div>

    <div id="screen-vvm" class="screen">
        <h2>Station 1: Cold Chain & VVM</h2>
        <p>Inspect the vaccine vials. <strong>Click to select ONLY the usable ones.</strong> Leave the unusable ones unselected.</p>
        <div id="vvm-container" class="vvm-grid"></div>
        <div id="vvm-feedback" class="feedback"></div>
        <button class="btn-success" onclick="validateVVM()">Check Selection</button>
    </div>

    <div id="screen-ovp" class="screen">
        <h2>Station 2: Open Vial Policy</h2>
        <div class="highlight">
            <h3 id="ovp-question-text" style="margin-top:0">Loading...</h3>
        </div>
        <div id="ovp-buttons">
            <button class="btn-success" onclick="handleOVPAnswer(true)">‚úÖ Usable</button>
            <button class="btn-danger" onclick="handleOVPAnswer(false)">üóëÔ∏è Discard</button>
        </div>
        <div id="ovp-feedback" class="feedback"></div>
    </div>

    <div id="screen-schedule" class="screen">
        <h2>Station 3: Immunization Schedule</h2>
        <div class="highlight">
            Patient: <strong id="patient-profile-text" style="font-size: 1.2rem;">...</strong>
        </div>
        <p>Select all vaccines applicable for this visit (Alphabetical Order):</p>
        <div id="vaccine-container" class="vaccine-grid"></div>
        <div id="schedule-feedback" class="feedback"></div>
        <button class="btn-success" onclick="validateSchedule()">Verify Schedule</button>
    </div>

    <div id="screen-route" class="screen">
        <h2>Station 4: Administration Technique</h2>
        <div class="child-view">
            <div class="child-emoji">üë∂</div>
            <div>
                <div>Administering:</div>
                <strong id="current-vax-name" style="font-size: 1.5rem; color: var(--accent);">...</strong>
            </div>
        </div>
        
        <div class="rs-container">
            <div class="rs-column" id="col-route">
                <strong>Route</strong>
                <div class="rs-option" onclick="selectOption('route', 'Oral', this)">Oral (Drops)</div>
                <div class="rs-option" onclick="selectOption('route', 'Intradermal', this)">Intradermal (ID)</div>
                <div class="rs-option" onclick="selectOption('route', 'Intramuscular', this)">Intramuscular (IM)</div>
                <div class="rs-option" onclick="selectOption('route', 'Subcutaneous', this)">Subcutaneous (SC)</div>
            </div>
            <div class="rs-column" id="col-site">
                <strong>Site</strong>
                <div class="rs-option" onclick="selectOption('site', 'Mouth', this)">Mouth</div>
                <div class="rs-option" onclick="selectOption('site', 'Left Upper Arm', this)">Left Upper Arm</div>
                <div class="rs-option" onclick="selectOption('site', 'Right Upper Arm', this)">Right Upper Arm</div>
                <div class="rs-option" onclick="selectOption('site', 'Mid-Thigh', this)">Anterolateral Mid-Thigh</div>
                <div class="rs-option" onclick="selectOption('site', 'Gluteal', this)">Gluteal (Buttock)</div>
            </div>
        </div>
        <div id="route-feedback" class="feedback"></div>
        <button id="btn-route-check" class="btn-success" onclick="validateRoute()">Administer</button>
    </div>

    <div id="screen-waste" class="screen">
        <h2>Station 5: Waste Management</h2>
        <p>Click an item on the left, then click the correct bin on the right.</p>
        
        <div class="waste-zone">
            <div class="waste-items">
                <div class="waste-item" id="w-wrapper" onclick="selectWaste('wrapper', this)">
                    üç¨<br><span class="syringe-state">Plastic Wrapper</span>
                </div>
                <div class="waste-item" id="w-cotton" onclick="selectWaste('cotton', this)">
                    ü©∏<br><span class="syringe-state">Soiled Cotton</span>
                </div>
                <div class="waste-item" id="w-syringe" onclick="selectWaste('syringe', this)">
                    üíâ<br><span id="lbl-syringe" class="syringe-state">AD Syringe (With Needle)</span>
                </div>
            </div>
            
            <div class="bin-row">
                <div class="bin bin-white" onclick="useBin('white')">Hub Cutter<br>(White)</div>
                <div class="bin bin-red" onclick="useBin('red')">Red</div>
                <div class="bin bin-yellow" onclick="useBin('yellow')">Yellow</div>
                <div class="bin bin-blue" onclick="useBin('blue')">Blue</div>
            </div>
        </div>
        <div id="waste-feedback" class="feedback"></div>
    </div>

    <div id="screen-result" class="screen" style="text-align: center;">
        <h1>Session Complete</h1>
        <p>Student: <strong id="res-name"></strong></p>
        <p>Roll No: <strong id="res-roll"></strong></p>
        <div style="font-size: 4rem; font-weight: bold; color: var(--accent); margin: 20px 0;">
            <span id="res-score">0</span>
        </div>
        <p>Scenario: <span id="res-scenario"></span></p>
        
        <button class="btn-primary" onclick="submitGoogleForm()">üì§ Submit to Faculty</button>
        <br><br>
        <button class="btn-outline" onclick="location.reload()">üîÑ Start New Session</button>
    </div>

</div>

<script>
    /* =========================================
       1. CONFIGURATION & DATA
       ========================================= */
    const FORM_CONFIG = {
            url: "https://docs.google.com/forms/d/e/1FAIpQLSfgBDH5DXNNADQwQQZlfMiatxkFLLY4iveP5jSHMl1z_1SWBQ/viewform", 
            nameID: "entry.1463400327",       // Entry ID for Name
            rollID: "entry.497790852",       // Entry ID for Roll No
            scoreID: "entry.1104804047",      // Entry ID for Score
            scenarioID: "entry.1366785076"    // Entry ID for Scenario
        };

    const VACCINES_LIST = [
        "BCG", "DPT-Booster-1", "DPT-Booster-2", "fIPV-1", "fIPV-2", 
        "HepB-0", "JE-1", "JE-2", "MR-1", "MR-2", "OPV-0", "OPV-1", 
        "OPV-2", "OPV-3", "OPV-Booster", "PCV-1", "PCV-2", "PCV-Booster", 
        "Pentavalent-1", "Pentavalent-2", "Pentavalent-3", "Rotavirus-1", 
        "Rotavirus-2", "Rotavirus-3", "TT", "Vitamin A (1ml)", "Vitamin A (2ml)"
    ];

    const VACCINE_RULES = {
        "BCG": { route: "Intradermal", site: "Left Upper Arm" },
        "HepB-0": { route: "Intramuscular", site: "Mid-Thigh" },
        "OPV": { route: "Oral", site: "Mouth" },
        "Pentavalent": { route: "Intramuscular", site: "Mid-Thigh" },
        "Rotavirus": { route: "Oral", site: "Mouth" },
        "PCV": { route: "Intramuscular", site: "Mid-Thigh" },
        "fIPV": { route: "Intradermal", site: "Right Upper Arm" },
        "MR": { route: "Subcutaneous", site: "Right Upper Arm" },
        "JE": { route: "Subcutaneous", site: "Left Upper Arm" },
        "DPT": { route: "Intramuscular", site: "Mid-Thigh" },
        "Vitamin A": { route: "Oral", site: "Mouth" },
        "TT": { route: "Intramuscular", site: "Left Upper Arm" } 
    };

    const PATIENTS = [
        { label: "Newborn (Birth Dose)", correct: ["BCG", "OPV-0", "HepB-0"] },
        { label: "6 Weeks Old", correct: ["OPV-1", "Pentavalent-1", "Rotavirus-1", "fIPV-1", "PCV-1"] },
        { label: "10 Weeks Old", correct: ["OPV-2", "Pentavalent-2", "Rotavirus-2"] },
        { label: "14 Weeks Old", correct: ["OPV-3", "Pentavalent-3", "Rotavirus-3", "fIPV-2", "PCV-2"] },
        { label: "9 Months Old", correct: ["MR-1", "JE-1", "PCV-Booster", "Vitamin A (1ml)"] }
    ];

    /* =========================================
       2. GLOBAL STATE
       ========================================= */
    let gameState = {
        name: "",
        roll: "",
        score: 0,
        patient: null,
        ovpIndex: 0,
        selectedVaccines: [],
        routeQueue: [],
        currentRouteVax: "",
        wasteSelected: null,
        needleCut: false,
        routeChoice: "",
        siteChoice: ""
    };

    /* =========================================
       3. NAVIGATION ENGINE
       ========================================= */
    function navigateTo(screenId) {
        // Hide all screens
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        // Show target
        const target = document.getElementById(screenId);
        if(target) {
            target.classList.add('active');
            // Auto-trigger setup functions
            if(screenId === 'screen-vvm') setupVVM();
            if(screenId === 'screen-ovp') setupOVP();
            if(screenId === 'screen-schedule') setupSchedule();
            if(screenId === 'screen-route') setupRoute();
            if(screenId === 'screen-waste') setupWaste();
            if(screenId === 'screen-result') setupResult();
        } else {
            console.error("Screen ID not found:", screenId);
        }
    }

    /* =========================================
       4. GAME LOGIC FUNCTIONS
       ========================================= */

    function startGame() {
        const n = document.getElementById('inp-name').value.trim();
        const r = document.getElementById('inp-roll').value.trim();
        
        if(!n || !r) {
            alert("Please enter Name and Roll Number.");
            return;
        }

        // Hard Reset State
        gameState.name = n;
        gameState.roll = r;
        gameState.score = 0;
        gameState.ovpIndex = 0;
        gameState.selectedVaccines = [];
        gameState.needleCut = false;
        
        // Pick Random Patient
        gameState.patient = PATIENTS[Math.floor(Math.random() * PATIENTS.length)];

        // Update Header
        document.getElementById('header-name').innerText = n;
        document.getElementById('header-score').innerText = "0";

        navigateTo('screen-vvm');
    }

    function addScore(points) {
        gameState.score += points;
        document.getElementById('header-score').innerText = gameState.score;
    }

    /* --- STATION 1: VVM --- */
    function setupVVM() {
        const container = document.getElementById('vvm-container');
        container.innerHTML = "";
        document.getElementById('vvm-feedback').style.display = 'none';
        
        const cards = [
            { id: 1, color: "#fff", valid: true, label: "Stage 1" },
            { id: 2, color: "#dcdcdc", valid: true, label: "Stage 2" },
            { id: 3, color: "#5d3f6a", valid: false, label: "Stage 3" },
            { id: 4, color: "#2c1e30", valid: false, label: "Stage 4" }
        ];
        // Randomize
        cards.sort(() => Math.random() - 0.5);

        cards.forEach(c => {
            const el = document.createElement('div');
            el.className = 'vvm-card';
            el.dataset.valid = c.valid;
            el.onclick = () => el.classList.toggle('selected');
            el.innerHTML = `
                <div class="vvm-circle"><div class="vvm-square" style="background:${c.color}"></div></div>
                <strong>${c.label}</strong>
            `;
            container.appendChild(el);
        });
    }

    function validateVVM() {
        const cards = document.querySelectorAll('.vvm-card');
        let error = false;
        cards.forEach(c => {
            const isSel = c.classList.contains('selected');
            const isValid = c.dataset.valid === "true";
            if(isSel !== isValid) error = true;
        });

        const fb = document.getElementById('vvm-feedback');
        fb.style.display = 'block';
        
        if(!error) {
            fb.className = "feedback success";
            fb.innerText = "‚úÖ Correct! You identified usable vs unusable vials.";
            addScore(10);
            setTimeout(() => navigateTo('screen-ovp'), 1500);
        } else {
            fb.className = "feedback error";
            fb.innerText = "‚ùå Incorrect. Rule: Use if square is lighter. Discard if matches or darker.";
            addScore(-5);
        }
    }

    /* --- STATION 2: OVP --- */
    const OVP_QS = [
        { q: "Pentavalent vial opened 15 days ago. Cold chain maintained. VVM good. Use?", ans: true, note: "Liquid vaccines (Penta/IPV/Td) open vial policy applies (28 days)." },
        { q: "Measles vial (Reconstituted) opened 6 hours ago. Cold chain maintained. Use?", ans: false, note: "Reconstituted vaccines must be discarded after 4 hours." }
    ];

    function setupOVP() {
        // Check if we are done
        if(gameState.ovpIndex >= OVP_QS.length) {
            navigateTo('screen-schedule');
            return;
        }
        
        // Reset UI for next question
        const q = OVP_QS[gameState.ovpIndex];
        document.getElementById('ovp-question-text').innerText = `Scenario ${gameState.ovpIndex+1}: ${q.q}`;
        document.getElementById('ovp-buttons').style.display = 'block';
        document.getElementById('ovp-feedback').style.display = 'none';
    }

    function handleOVPAnswer(userChoice) {
        const q = OVP_QS[gameState.ovpIndex];
        const fb = document.getElementById('ovp-feedback');
        fb.style.display = 'block';
        document.getElementById('ovp-buttons').style.display = 'none';

        if(userChoice === q.ans) {
            fb.className = "feedback success";
            fb.innerText = "‚úÖ Correct. " + q.note;
            addScore(5);
        } else {
            fb.className = "feedback error";
            fb.innerText = "‚ùå Incorrect. " + q.note;
            addScore(-5);
        }

        gameState.ovpIndex++;
        setTimeout(setupOVP, 2500); // Wait then reload station logic
    }

    /* --- STATION 3: SCHEDULE --- */
    function setupSchedule() {
        document.getElementById('patient-profile-text').innerText = gameState.patient.label;
        document.getElementById('schedule-feedback').style.display = 'none';
        
        const container = document.getElementById('vaccine-container');
        container.innerHTML = "";
        
        VACCINES_LIST.forEach(v => {
            const el = document.createElement('div');
            el.className = 'vax-tag';
            el.innerText = v;
            el.onclick = () => {
                el.classList.toggle('active');
                if(gameState.selectedVaccines.includes(v)) {
                    gameState.selectedVaccines = gameState.selectedVaccines.filter(x => x !== v);
                } else {
                    gameState.selectedVaccines.push(v);
                }
            };
            container.appendChild(el);
        });
    }

    function validateSchedule() {
        const needed = gameState.patient.correct;
        const chosen = gameState.selectedVaccines;
        
        const missing = needed.filter(x => !chosen.includes(x));
        const extra = chosen.filter(x => !needed.includes(x));
        
        const fb = document.getElementById('schedule-feedback');
        fb.style.display = 'block';

        if(missing.length === 0 && extra.length === 0) {
            fb.className = "feedback success";
            fb.innerText = "‚úÖ Perfect schedule selection.";
            addScore(20);
            setTimeout(() => navigateTo('screen-route'), 1500);
        } else {
            fb.className = "feedback error";
            fb.innerText = `‚ùå Error. Missing: ${missing.join(', ')}.`;
            addScore(-5);
        }
    }

    /* --- STATION 4: ROUTE --- */
    function setupRoute() {
        // Initialize queue based on correct vaccines for patient
        if(gameState.routeQueue.length === 0) {
            gameState.routeQueue = [...gameState.patient.correct];
        }
        
        if(gameState.routeQueue.length === 0) {
            navigateTo('screen-waste');
            return;
        }

        gameState.currentRouteVax = gameState.routeQueue.shift();
        gameState.routeChoice = "";
        gameState.siteChoice = "";

        // UI Reset
        document.getElementById('current-vax-name').innerText = gameState.currentRouteVax;
        document.getElementById('route-feedback').style.display = 'none';
        document.getElementById('btn-route-check').style.display = 'inline-block';
        document.querySelectorAll('.rs-option').forEach(el => el.classList.remove('selected'));
    }

    function selectOption(type, val, el) {
        // Clear column
        const colId = type === 'route' ? 'col-route' : 'col-site';
        document.getElementById(colId).querySelectorAll('.rs-option').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
        
        if(type === 'route') gameState.routeChoice = val;
        else gameState.siteChoice = val;
    }

    function validateRoute() {
        if(!gameState.routeChoice || !gameState.siteChoice) {
            alert("Select both Route and Site.");
            return;
        }

        // Generic lookup helper
        let generic = gameState.currentRouteVax;
        Object.keys(VACCINE_RULES).forEach(key => {
            if(gameState.currentRouteVax.includes(key)) generic = key;
        });

        const correct = VACCINE_RULES[generic];
        const fb = document.getElementById('route-feedback');
        fb.style.display = 'block';

        if(gameState.routeChoice === correct.route && gameState.siteChoice === correct.site) {
            fb.className = "feedback success";
            fb.innerText = "‚úÖ Correct technique.";
            addScore(5);
            document.getElementById('btn-route-check').style.display = 'none';
            setTimeout(setupRoute, 1000);
        } else {
            fb.className = "feedback error";
            fb.innerText = `‚ùå Incorrect. ${generic} is given via ${correct.route} at ${correct.site}.`;
            addScore(-5);
            document.getElementById('btn-route-check').style.display = 'none';
            setTimeout(setupRoute, 2500);
        }
    }

    /* --- STATION 5: WASTE --- */
    function setupWaste() {
        document.getElementById('waste-feedback').style.display = 'none';
    }

    function selectWaste(id, el) {
        if(el.classList.contains('done')) return;
        
        gameState.wasteSelected = id;
        document.querySelectorAll('.waste-item').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
    }

    function useBin(binColor) {
        if(!gameState.wasteSelected) return;

        const fb = document.getElementById('waste-feedback');
        fb.style.display = 'block';
        let correct = false;
        let msg = "";

        if(gameState.wasteSelected === 'wrapper') {
            if(binColor === 'red') { correct = true; msg = "Correct! Red bin for plastics."; }
            else { correct = false; msg = "Plastics go in Red Bin."; }
        }
        else if(gameState.wasteSelected === 'cotton') {
            if(binColor === 'yellow') { correct = true; msg = "Correct! Soiled waste in Yellow."; }
            else { correct = false; msg = "Soiled waste goes in Yellow Bin."; }
        }
        else if(gameState.wasteSelected === 'syringe') {
            if(binColor === 'white') {
                correct = true; 
                msg = "Correct! Hub cut. Needle contained.";
                gameState.needleCut = true;
                // Transform item to hub
                const el = document.getElementById('w-syringe');
                el.innerHTML = "üíâ<br>Plastic Hub";
                el.id = "w-hub";
                el.onclick = function() { selectWaste('hub', this) };
                el.classList.remove('selected');
                gameState.wasteSelected = null;
                addScore(10);
                fb.className = "feedback success";
                fb.innerText = msg;
                return; // Don't mark done yet, need to dispose hub
            } else {
                correct = false; msg = "‚ö†Ô∏è DANGER: Never dispose uncapped needle! Use Hub Cutter.";
            }
        }
        else if(gameState.wasteSelected === 'hub') {
            if(binColor === 'red') { correct = true; msg = "Correct! Cut hub in Red Bin."; }
            else { correct = false; msg = "Plastic hub goes in Red Bin."; }
        }

        if(correct) {
            fb.className = "feedback success";
            fb.innerText = msg;
            addScore(5);
            // Mark items done (except syringe which handled above)
            if(gameState.wasteSelected !== 'hub' && gameState.wasteSelected !== 'syringe') {
                document.querySelector('.waste-item.selected').classList.add('done');
            } else if (gameState.wasteSelected === 'hub') {
                document.getElementById('w-hub').classList.add('done');
            }
            
            gameState.wasteSelected = null;
            
            // Check completion
            const remaining = document.querySelectorAll('.waste-item:not(.done)').length;
            if(remaining === 0) setTimeout(() => navigateTo('screen-result'), 1500);
        } else {
            fb.className = "feedback error";
            fb.innerText = msg;
            addScore(-5);
        }
    }

    /* --- RESULT --- */
    function setupResult() {
        document.getElementById('res-name').innerText = gameState.name;
        document.getElementById('res-roll').innerText = gameState.roll;
        document.getElementById('res-score').innerText = gameState.score;
        document.getElementById('res-scenario').innerText = gameState.patient.label;
    }

    function submitGoogleForm() {
        const base = FORM_CONFIG.url;
        const qParams = [
            `${FORM_CONFIG.nameID}=${encodeURIComponent(gameState.name)}`,
            `${FORM_CONFIG.rollID}=${encodeURIComponent(gameState.roll)}`,
            `${FORM_CONFIG.scoreID}=${gameState.score}`,
            `${FORM_CONFIG.scenarioID}=${encodeURIComponent(gameState.patient.label)}`
        ];
        const fullUrl = `${base}?usp=pp_url&${qParams.join('&')}`;
        window.open(fullUrl, '_blank');
    }

</script>
</body>
</html>
